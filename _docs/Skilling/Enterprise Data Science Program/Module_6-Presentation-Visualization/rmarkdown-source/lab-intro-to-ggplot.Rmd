
---
class: middle,center

# A ggplot2 primer

---
## What is ggplot2?

- A second (and final) iteration of the ggplot
- Implementation of Wilkerson's Grammar of Graphics in R
- Conceptually, a way to layer different elements onto a canvas to create a data visualization
- Started as Dr. Hadley Wickham's PhD thesis (with Dr. Dianne Cook)
- Won the John M. Chambers Statistical Software Award in 2006

- Mimicked in other software platforms
  - `ggplot` and `seaborn` in Python
  - Translated in `plotly`

---

## ggplot2 uses the __grammar__ of __graphics__

.pull-left[
### A grammar ...

- compose and re-use small parts
- build complex structures from simpler units

]

--

.pull-right[
### of graphics ...

- Think of yourself as a painter
- Build a visualization  using layers on a canvas
- Draw layers on top of each other
]

---

```{css intro-to-ggplot-1, echo=FALSE}
.remark-code-line-highlighted { background-color: green; } /* modified */
```


## Introduction to ggplot2

The `ggplot2` package is a very flexible and (to me) intuitive way of visualizing data.
It is based on the concept of layering elements on a canvas.

> This idea of layering graphics on a canvas is, to me, a nice way of building graphs

You need:

+ A `data.frame` object
+ _Aesthetic mappings_ (aes) to say what data is used for what purpose in the viz
    + x- and y-direction
    + shapes, colors, lines
+ A _geometry object_ (geom) to say what to draw
    + You can "layer" geoms on each other to build plots
    
---
background-image: url(`r img_path('grammar-of-graphics.png')`)
background-size: 80%,100%

---



## A dataset


```{r 05-Plotting-16, echo = T, message = F}
library(tidyverse)
library(rio)
beaches <- import('data/sydneybeaches3.csv')
```
```{r 05-Plotting-17, echo = F}
head(beaches)
```

<p align="right" style="font-size: 10pt;">Credit: D. J. Navarro</p>

.footnote[Download the `sydneybeaches3.csv` file from the website and save it in your project's data folder]


---
class: middle, center

# Building a graph

---

.pull-left[
### Start with a blank canvas

```{r gr2, eval=F}
ggplot()
```
]
.pull-right[

### 

```{r intro-to-ggplot-2, ref.label='gr2', eval=T, echo = F}

```

]

---

.pull-left[
### Add a data set

```{r gr3, eval=F}
ggplot(
  data = beaches # Tell ggplot the data you're using #<<
)
```

> Nothing has really happened yet, since we haven't said what we want to plot from the data set

> The `#` symbol tells R that anything after it is a *comment* and should be ignored. We'll make a lot of use of comments in our code.
]
.pull-right[

### 

```{r intro-to-ggplot-3, ref.label='gr3', eval=T, echo = F}

```


]


---

.pull-left[
### Add a mapping from data to elements

```{r gr4, eval=F}
ggplot(
  data = beaches,
  mapping = aes( #<<
    x = temperature, #<<
    y = rainfall #<<
  )
)
```

What goes in 

- the x and y axes
- the color of markers
- the shape of markers
]
.pull-right[

### 

```{r intro-to-ggplot-4, ref.label='gr4', eval=T, echo = F}

```

> Now we've said what we want to plot, so axes get drawn. We haven't yet specified how we want to plot it

]

---

.pull-left[
### Add a geometry to draw

```{r gr5, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point() #<<
```

What to draw:

- Points, lines
- histogram, bars, pies
]
.pull-right[

### 

```{r intro-to-ggplot-5, ref.label='gr5', eval=T, echo = F}

```

> Now we've said **how** we want to plot the things we want from the data
]

---

.pull-left[
### Add options for the geom

```{r gr6, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point(size = 4) #<<
```

> Options pertaining to how we want things drawn are usually put in the function for the geometry, e.g. `geom_point`, `geom_line`, etc. If the option is based on any element from the dataset, we have to wrap it in a `aes()` function. We'll see this later
]
.pull-right[

### 

```{r intro-to-ggplot-6, ref.label='gr6', eval=T, echo = F}

```

]

---

.pull-left[
### Add a mapping to modify the geom

```{r gr7, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point(
    mapping = aes(color = season_name), #<<
    size = 4
  )
```

> Anything data-driven has to be a mapping, driven by the `aes` function

]
.pull-right[

### 

```{r intro-to-ggplot-7, ref.label='gr7', eval=T, echo = F}

```

]

---
class:middle, center

# A side note on `aes`

---

## The `aes` function

The `aes` function and when it needs to be used creates quite a bit of confusion initially. Let's start with the documentation for this function

```{r intro-to-ggplot-8, eval=F}
?aes
```

> #### Description
Aesthetic mappings describe how variables in the data are mapped to visual properties (aesthetics) of geoms. Aesthetic mappings can be set in ggplot2() and in individual layers.

So, anytime we want to represent some aspect of the data on the plot in some form (color, shape, etc.), we have to use the `aes` function to *map* the data to the plot
---

## The `aes` function

The `aes` function can occur in one of two places:

.panelset[
.panel[.panel-name[Within the `ggplot` function]
.pull-left[
```{r intro-to-ggplot-9, fig.height=2, echo=T, eval=F}
ggplot(
  data=beaches,
  mapping=aes(
    x = temperature,
    y = rainfall
  )
) + 
  geom_point()
```
]
.pull-right[
```{r, echo=F, eval=T, ref.label='intro-to-ggplot-9'}

```

]
]
.panel[.panel-name[In the actual `geom` layer]
.pull-left[
```{r intro-to-ggplot-10, fig.height=2, echo=T, eval=F}
ggplot(
  data = beaches
) +
  geom_point(
    mapping = aes(
      x = temperature,
      y = rainfall
    )
  )
```
]
.pull-right[
```{r, echo=F, eval=T, ref.label='intro-to-ggplot-10'}

```
]
]
]

---

## The `aes` function

The `aes` function can occur in one of two places:

.panelset[
.panel[.panel-name[Within the `ggplot` function]
+ You do this if the same mapping will be common to **all** the subsequent geometry layers
]
.panel[.panel-name[In the actual `geom` layer]
+ You do this if the mapping will apply **only** to that layer
+ You do it if it makes more sense to put it in the `geom`. 
]
]



---
class: middle, center

# Facets / Trellis / Small multiples

---
.pull-left[
### Split into facets

```{r gr8, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point(
    mapping = aes(color = season_name),
    size = 4
  ) +
  facet_wrap( ~ season_name) #<<
```

> Create separate plots based on unique values of some variable (`season_name`) in your dataset

> Typically this variable should a few distinct values
]
.pull-right[

### 

```{r intro-to-ggplot-11, ref.label='gr8', eval=T, echo = F}

```

]

---

.pull-left[
### Remove the legend

```{r gr9, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point(
    mapping = aes(color = season_name),
    size = 4,
    show.legend = FALSE #<<
  ) +
  facet_wrap( ~ season_name) 
```

> Now we're getting more into the look of the plot and how much information should be on it

> `show.legend` option is in `geom_point` here since it would be based on the colors of the points. If you had a different geometry like `geom_line`, you would put the `show.legend` option there if the legend was based on that geom.
]
.pull-right[

### 

```{r intro-to-ggplot-12, ref.label='gr9', eval=T, echo = F}

```

]

---

.pull-left[
### Change the background

```{r gr10, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point(
    mapping = aes(color = season_name),
    size = 4,
    show.legend = FALSE
  ) +
  facet_wrap( ~ season_name) +
  theme_bw() #<<
```

> Again, a look-and-feel choice

> In-built `ggplot` themes are described [here](https://ggplot2.tidyverse.org/reference/ggtheme.html). Other themes are availabe via packages [`ggthemes`](https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/) and others.

]
.pull-right[

### 

```{r intro-to-ggplot-13, ref.label='gr10', eval=T, echo = F}

```

]

---

.pull-left[
### Update the labels

```{r gr11, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point(
    mapping = aes(color = season_name),
    size = 4,
    show.legend = FALSE
  ) +
  facet_wrap( ~ season_name) +
  theme_bw() +
  labs(x = 'Temperature (C)', y = 'Rainfall (mm)') #<<
```

> This is **important**. Make sure the information in your plot is self-contained by putting appropriate labels and titles on it.
]
.pull-right[

### 

```{r intro-to-ggplot-14, ref.label='gr11', eval=T, echo = F}

```

]

---

.pull-left[
### Add titles

```{r gr12, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point(
    mapping = aes(color = season_name),
    size = 4,
    show.legend = FALSE
  ) +
  facet_wrap( ~ season_name) +
  theme_bw() +
  labs(x = 'Temperature (C)', 
       y = 'Rainfall (mm)',
       title = 'Sydney weather by season', #<<
       subtitle = "Data from 2013 to 2018") #<<
```

]
.pull-right[

### 

```{r intro-to-ggplot-15, ref.label='gr12', eval=T, echo = F}

```

]

---

.pull-left[
### Customize

```{r gr13, eval=F}
ggplot(
  data = beaches,
  mapping = aes(
    x = temperature,
    y = rainfall
  )
) +
  geom_point(
    mapping = aes(color = season_name),
    size = 4,
    show.legend = FALSE
  ) +
  facet_wrap( ~ season_name) +
  theme_bw() +
  labs(x = 'Temperature (C)', 
       y = 'Rainfall (mm)',
       title = 'Sydney weather by season', 
       subtitle = "Data from 2013 to 2018") +
  theme(axis.title = element_text(size = 14), #<<
        axis.text = element_text(size = 12), #<<
        strip.text = element_text(size = 12)) #<<
```

]
.pull-right[

### 

```{r intro-to-ggplot-16, ref.label='gr13', eval=T, echo = F}

```

> Once again, a look-and-feel choice, but this is very useful for publications when the actual figure will be smaller but we need the labels to be legible.
]

---
class: middle, center

# Understanding the structure of ggplot

---
background-image: url(`r img_path('grammar.png')`)
background-size: contain

---

## The grammar
.left-column70[
- Data
- Aesthetics (or aesthetic mappings)
- Geometries (as layers)
- Facets
- Themes
- (Coordinates)
- (Scales)
]
.right-column70[
> Data, Aesthetics and Geometries are **required** to actually create a plot
]

---
background-image: url(`r img_path('ggplot_geoms.png')`)
background-size: 50%,100%

### Choices for aesthetics and geometries

---
background-image: url(`r img_path('ggplot_themes.png')`)
background-size: 62%,100%

### Choices in themes

---

## Themes

```{r intro-to-ggplot-17, echo=FALSE, fig.asp=0.5, out.width='80%'}
p <- mpg %>% mutate(cyl=as.factor(cyl)) %>% 
  ggplot( aes(x = displ, y = cty))+geom_point(aes(color = cyl), show.legend=F)+
  labs(x = 'Displacement',
       y = 'City efficiency')

plt_list <- list(
  p+theme_grey()+labs(title='grey'),
  p+theme_bw()+labs(title='bw'),
  # p+theme_linedraw()+labs(title='linedraw'),
  p+theme_light()+labs(title='light'),
  p+theme_dark() + labs(title='dark'),
  p+theme_minimal() + labs(title='minimal'),
  p+theme_classic() + labs(title='classic')
  # p+theme_void() + labs(title='void')
)

cowplot::plot_grid(plotlist = plt_list, nrow=2)
```

---

## Themes

```{r intro-to-ggplot-18, echo=FALSE, fig.asp=0.5, out.width='80%'}
pacman::p_load(char=c('hrbrthemes','ggthemes','bbplot','wesanderson','xkcd','extrafont'))
pacman::p_load_gh('ricardo-bion/ggtech', 'bbc/bbplot')

plts <- list(
  p + theme_ipsum() + labs(title='hrbrthemes::ipsum'),
  p + theme_excel() + labs(title='ggthemes::excel'),
  p + theme_economist() + labs(title='ggthemes::economist'),
  p + theme_wsj() + labs(title = 'ggthemes::wsj'),
  p + theme_few() + labs(title='ggthemes::few'),
  p + theme_tufte() + labs(title='ggtheme::tufte'),
  p + theme_tech(theme='facebook') + labs(title='ggtech::facebook'),
  p + theme_tech(theme='twitter') + labs(title='ggtech::twitter'),
  p + theme_tech(theme='etsy') + labs(title='ggtech::etsy')
)

cowplot::plot_grid(plotlist=plts, nrow=3)

```

---
class: middle, center

# Peeking under the hood

---
.pull-left[
### If I write...

```{r intro-to-ggplot-19, eval = F, echo = T}
ggplot(
  data = beaches,
  aes(x = temperature,
      y = rainfall)
) + 
  geom_point()+
  geom_smooth()
```

]
--
.pull-right[
### what's really run is ...

```{r intro-to-ggplot-20,echo = T, eval = F}
ggplot(
  data = beaches, 
  mapping = aes(
    x = temperature, y = rainfall)) + 
layer(
  geom = "point",
  stat = "identity",
  position = "identity") + 
layer(
  geom = GeomSmooth,
  stat='smooth',
  position='identity') + 
)
facet_null() +
theme_grey() + 
coord_cartesian() + 
scale_x_continuous() + 
scale_y_continuous()
```

]

--

A **layer** has five components: *mapping, data, geom, stat and position*; a **geom_* ** makes a shortcut

*mapping* and *data* are usually inherited from the top `ggplot` call, unless it is specified in the geom.
--

### Each element can be adapted and tweaked to create graphs

---
background-image: url(`r img_path('ggplot_hh.png')`)
background-size: contain

---
class: middle,center

## We will go into creating themes, color choices and the like in a future activity

